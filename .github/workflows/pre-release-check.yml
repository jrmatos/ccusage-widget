name: Pre-Release Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  check:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run lint checks
      run: npm run lint

    - name: Run type checks
      run: npm run typecheck

    - name: Run tests
      run: npm test

    - name: Build application
      run: npm run build

    - name: Verify build output
      run: |
        echo "ğŸ“¦ Verifying build output..."
        if [ ! -d "dist" ]; then
          echo "âŒ Build directory 'dist' not found"
          exit 1
        fi
        if [ ! -f "dist/main.js" ]; then
          echo "âŒ Main entry point 'dist/main.js' not found"
          exit 1
        fi
        echo "âœ… Build output verified successfully"

    - name: Create distributable (dry-run)
      run: npm run dist
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Test package creation
      run: |
        echo "ğŸ“¦ Testing package creation..."
        npm pack
        # Check package size
        PACKAGE_SIZE=$(ls -lh *.tgz | awk '{print $5}')
        echo "ğŸ“Š Package size: $PACKAGE_SIZE"
        
        # Extract and verify package contents
        tar -tzf *.tgz | head -20
        
        # Clean up
        rm *.tgz
        echo "âœ… Package creation test passed"

    - name: Test global installation simulation
      run: |
        echo "ğŸ§ª Simulating global installation..."
        npm pack
        
        # Create a temporary directory for testing
        TEMP_DIR=$(mktemp -d)
        cd $TEMP_DIR
        
        # Install the package locally to test
        npm init -y > /dev/null
        npm install $GITHUB_WORKSPACE/*.tgz
        
        # Check if bin script exists and is executable
        if [ ! -f "node_modules/ccusage-widget/bin/ccusage-widget.js" ]; then
          echo "âŒ Bin script not found in package"
          exit 1
        fi
        
        # Clean up
        cd $GITHUB_WORKSPACE
        rm -rf $TEMP_DIR
        rm *.tgz
        echo "âœ… Global installation simulation passed"

    - name: Check version consistency
      run: |
        echo "ğŸ” Checking version consistency..."
        PACKAGE_VERSION=$(node -p "require('./package.json').version")
        echo "ğŸ“Œ Current package version: $PACKAGE_VERSION"
        
        # Check if version follows semver
        if ! echo "$PACKAGE_VERSION" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+' > /dev/null; then
          echo "âŒ Version does not follow semantic versioning"
          exit 1
        fi
        echo "âœ… Version format is valid"

    - name: Summary
      if: success()
      run: |
        echo "ğŸ‰ All pre-release checks passed!"
        echo "âœ… Lint checks"
        echo "âœ… Type checks"
        echo "âœ… Tests"
        echo "âœ… Build verification"
        echo "âœ… Package creation"
        echo "âœ… Installation simulation"
        echo "âœ… Version consistency"
        echo ""
        echo "ğŸ“ Ready for release when tagged!"